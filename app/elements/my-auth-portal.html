<dom-module id="my-auth-portal">
  <template>
    <style include="shared-styles">

    </style>

    <firebase-auth
        id="auth"
        user="{{user}}"
        status-known="{{statusKnown}}"
        provider="google">
    </firebase-auth>

    <paper-button raised on-tap="login" hidden$="[[user]]">Sign In</paper-button>
    <paper-button raised on-tap="logout" hidden$="[[!user]]">Sign Out</paper-button>

    <template is="dom-if" if="[[user]]">
      <my-dashboard user="[[user]]"></my-dashboard>
    </template>

  </template>
  <script>
    Polymer({
      is: "my-auth-portal",
      properties: {
        user: {
          type: Object,
        },
        statusKnown: {
          type: Object,
        },
      },

      login: function() {
        return this.$.auth.signInWithPopup()
          .then(function({user}) {

            var userData = user.providerData[0];
            // var getTimestamp = Date.now()

            var userObj = {
              timestamp: Date.now(),
              info: {
                uid: user.uid,
                name: userData.displayName,
                avatar: userData.photoURL,
                email: userData.email,
                lastUpdated: Date.now(),
              }
            }

            var promises = [];
            var ref = firebase.database().ref();

            promises.push(ref.child('/users/' + user.uid).set(userObj));

            return Promise.all(promises)
              .then(function() {
                var toast = document.querySelector('#toast');
                toast.text = "Logged in Successfully!"
                toast.show();
              });
          });
      },

      logout: function() {
        return this.$.auth.signOut();
      },
    });
  </script>
</dom-module>
