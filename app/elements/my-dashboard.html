<dom-module id="my-dashboard">
  <template>
    <style>
      :host {
        margin-top: 2rem;
      }
    </style>

    <firebase-query id="visualsQuery" path="/visuals" data="{{items}}"></firebase-query>

    <google-sheets
      scopes="https://spreadsheets.google.com/feeds"
      client-id="1065272399383-45jcbnefkch3kplkv07kvdm4k8vq3du8.apps.googleusercontent.com"
      key="10wsO_Go3Sv1WIxp-bhxPt1ILQIk5Lql6MRAYr87uBZE"
      tab-id="1"
      spreadsheets="{{spreadsheets}}"
      rows="{{rows}}">
    </google-sheets>

    <my-googlesheets-element spreadsheets="{{spreadsheets}}" user="[[user]]"></my-googlesheets-element>
    <my-visualisation-form user="[[user]]"></my-visualisation-form>
    <my-visualisation-list  on-update="updateData" on-delete="deleteVisualisation" data="{{items}}" user="[[user]]"></my-visualisation-list>



  </template>
  <script>
    Polymer({
      is: "my-dashboard",
      properties: {
        user: {
          type: Object
        },
        rows: {
          type: Object,
        },
        spreadsheets: {
          type: Array,
        },
      },
      observers: [
        'logSpreadsheets(spreadsheets.*)',
        'logUser(user.*)',
        'logRows(rows.*)'
      ],
      logUser: function() {
        console.log('user', this.user);
      },
      logRows: function() {
        console.log('rows', this.rows);
      },
      logSpreadsheets: function() {
        console.log("SS: my-dash", this.spreadsheets);
      },
      deleteVisualisation: function(data) {
        // console.log('data', data)
        var promises = [];
        var ref = firebase.database().ref();
        var visualId = data.detail.id;

        promises.push(ref.child('/visuals/' + visualId).remove());
        promises.push(ref.child('/usersVisuals/' + this.user.uid + '/' + visualId).remove());

        return Promise.all(promises)
          .then(function() {
            var toast = document.querySelector('#toast');
            toast.text = "Visualisation successfully deleted"
            toast.show();
          })
          .catch(function(error) {
            console.log("Something went wrong", error.message);
          });
      },

      updateData: function(visInfo) {
        // console.log("Visual Data", visInfo.detail)
        var promises = [];
        var ref = firebase.database().ref();
        var visualId = visInfo.detail.id;

        var updatedVisData = {
          info: {
            visualId: visInfo.detail.id,
            uid: this.user.uid,
            title: visInfo.detail.title,
            type: visInfo.detail.type,
            data: visInfo.detail.data,
            lastUpdated: Date.now(),
          }
        }

        promises.push(ref.child('/visuals/' + visualId).update(updatedVisData));
        promises.push(ref.child('/usersVisuals/' + updatedVisData.info.uid + '/' + visualId).update(updatedVisData.info));

        return Promise.all(promises)
          .then(function() {
            var toast = document.querySelector('#toast');
            toast.text = "Visualisation Updated!"
            toast.show();
          })
          .catch(function(error) {
            console.log("Something went wrong", error.message);
          });
      },
    });
  </script>
</dom-module>


<!-- https://spreadsheets.google.com/ccc?key=10wsO_Go3Sv1WIxp-bhxPt1ILQIk5Lql6MRAYr87uBZE -->
