<dom-module id="my-dashboard">
  <template>
    <style>
    </style>

    <firebase-query id="visualsQuery" path="/visuals" data="{{items}}"></firebase-query>

    <h1>[[user.displayName]]'s dashboard.</h1>

    <my-visualisation-form user="[[user]]"></my-visualisation-form>

    <my-visualisation-list  on-update="updateData" on-delete="deleteVisualisation" data="{{items}}" user="[[user]]"></my-visualisation-list>



  </template>
  <script>
    Polymer({
      is: "my-dashboard",
      properties: {
        user: {
          type: Object
        },
      },

      deleteVisualisation: function(data) {
        // console.log('data', data)
        var promises = [];
        var ref = firebase.database().ref();
        var visualId = data.detail.id;

        promises.push(ref.child('/visuals/' + visualId).remove());
        promises.push(ref.child('/usersVisuals/' + this.user.uid + '/' + visualId).remove());

        return Promise.all(promises)
          .then(function() {
            var toast = document.querySelector('#toast');
            toast.text = "Visualisation successfully deleted"
            toast.show();
          })
          .catch(function(error) {
            console.log("Something went wrong", error.message);
          });
      },

      updateData: function(visInfo) {
        // console.log("Visual Data", visInfo.detail)
        var promises = [];
        var ref = firebase.database().ref();
        var visualId = visInfo.detail.id;

        var updatedVisData = {
          info: {
            visualId: visInfo.detail.id,
            uid: this.user.uid,
            title: visInfo.detail.title,
            type: visInfo.detail.type,
            data: visInfo.detail.data,
            lastUpdated: Date.now(),
          }
        }

        promises.push(ref.child('/visuals/' + visualId).update(updatedVisData));
        promises.push(ref.child('/usersVisuals/' + updatedVisData.info.uid + '/' + visualId).update(updatedVisData.info));

        return Promise.all(promises)
          .then(function() {
            var toast = document.querySelector('#toast');
            toast.text = "Visualisation Updated!"
            toast.show();
          })
          .catch(function(error) {
            console.log("Something went wrong", error.message);
          });
      },
    });
  </script>
</dom-module>
