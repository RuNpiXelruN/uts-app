<dom-module id="my-visualisation-list">
  <template>
    <style>
      :host {
        display: flex;
        flex-flow: row wrap;
        margin-top: 3rem;
      }

      .vis-wrapper {
        display: flex;
        flex-flow: row nowrap;
        margin: 1rem;
        box-shadow: 0vw 1vw 2vw 0vw rgba(0,0,0,0.1);
      }

      .vis-wrapper img {
        margin-left: auto;
      }

      .vis-textWrapper {
        display: flex;
        flex-flow: column nowrap;
        flex-grow: 1;
        padding: 0 2rem;
      }

      .edit-dialog {
        width: 50%;
      }

      .edit-form {
        display: flex;
        flex-flow: column nowrap;
      }

      .flexBtn-wrapper {
        display: flex;
        flex-flow: row nowrap;
        align-items: center;
        justify-content: space-between;
        margin-top: 1rem;
      }

      .update-button {
        background: #0F4BEB;
        color: #fff;
      }

      .close-button {
        background: #000;
        color: #fff;
      }

      .visButton-wrapper {
        display: flex;
        flex-flow: row nowrap;
        margin-top: 3rem;
      }

      #deleteIcon {
        margin-right: 0.5rem;
      }

    </style>

    <template is="dom-repeat" items="{{data}}" as="visual">

      <!-- - - - - - - - - - - - - - - - - - Data Loop / Iteration - - - - - - - - - - - - - - - - - -->

      <!-- TODO swap 'title' identifiers to 'name' instead to allow for nicer aria-label -->

      <div id$="[[visual.$key]]" class="vis-wrapper">
        <div class="vis-textWrapper">
          <p id="visTitle">[[visual.info.title]]</p>
          <p id="visType">[[visual.info.type]]</p>
          <!-- <paper-button raised on-tap="openUpdateDialog" title$="update_[[visual.$key]]">Edit</paper-button> -->
          <div class="visButton-wrapper">
            <paper-fab on-tap="confirmDeleteDialog" title$="delete_[[visual.$key]]" id="deleteIcon" icon="delete" mini></paper-fab>
            <paper-fab on-tap="openUpdateDialog" title$="update_[[visual.$key]]" id="updateIcon" icon="create" mini></paper-fab>
          </div>
          <!-- <paper-button raised on-tap="confirmDeleteDialog" title$="delete_[[visual.$key]]">Delete</paper-button> -->
        </div>
        <img src="http://placehold.it/100x200" alt="">
      </div>

      <!-- - - - - - - - - - - - - - - - - - - -End Data Loop - - - - - - - - - - - - - - - - - - -->


      <!-- - - - - - - - - - - - - - - - - - Edit / Update Dialog - - - - - - - - - - - - - - - - - -->

      <paper-dialog id$="update_[[visual.$key]]" class="edit-dialog">
        <div class="content">
          <form is="iron-form" id="editVis" class="edit-form">
            <paper-input id="title1" name="name" label="name" value={{visual.info.title}} required autocomplete></paper-input>
            <paper-input id="type" class="blue" name="type" label="type" value={{visual.info.type}} required autocomplete></paper-input>
            <paper-input id="data" class="blue" name="data" label="data" value={{visual.info.data}} required autocomplete></paper-input>
            <div class="flexBtn-wrapper">
              <paper-button id="close" class="close-button" on-click="closeUpdateDialog" title$="update_[[visual.$key]]" raised>Close</paper-button>
              <paper-button id="send" class="update-button" on-click="sendToUpdate" title$="update_[[visual.$key]]" raised>Update</paper-button>
            </div>
          </form>
        </div>
      </paper-dialog>

      <!-- - - - - - - - - - - - - - - - - - - -End Edit / Update - - - - - - - - - - - - - - - - - - -->


      <!-- - - - - - - - - - - - - - - - - - - - Delete Dialog - - - - - - - - - - - - - - - - - - - -->

      <paper-dialog id="delete_[[visual.$key]]" modal>
        <p>Are you sure you want to delete?</p>
        <paper-button raised on-click="sendToDelete" title$="delete_[[visual.$key]]">Confirm</paper-button>
        <paper-button raised on-click="closeDeleteConfirmDialog" title$="delete_[[visual.$key]]">Cancel</paper-button>
      </paper-dialog>

      <!-- - - - - - - - - - - - - - - - - - - -End Delete Dialog - - - - - - - - - - - - - - - - - - -->

    </template>

  </template>
  <script>
    Polymer({
      is: 'my-visualisation-list',
      properties: {
        items: {
          type: Object,
        },
        visual: {
          type: Object,
        },

      },

      // Validates current user owns visualisation --------------------------------------
      confirmCurrentUser(e) {
        if (this.user.uid === e.model.__data__.visual.info.uid) {
          return true
        } else {
          var toast = document.querySelector('#toast');
          toast.text = "This doesn't belong to you"
          toast.show();
          return false;
        }
      },

      // </ --------------------------------------------------------------------------- </



      // Delete Visualisation functions --------------------------------------------------

      closeDeleteConfirmDialog: function(e) {
        var deleteConfirmDialog = document.querySelector('#' + e.target.title);
        deleteConfirmDialog.toggle();
      },

      confirmDeleteDialog: function(e) {
        var deleteDialog = document.querySelector('#' + e.target.title);

        if ( this.confirmCurrentUser(e) ) {
          deleteDialog.toggle();
        }
      },

      sendToDelete: function(e) {
        var deleteConfirm = document.querySelector('#' + e.target.title)
        var visIdToDelete = {
          id: e.model.__data__.visual.$key,
        }
        this.fire('delete', visIdToDelete);
        deleteConfirm.toggle();
      },

      // </ --------------------------------------------------------------------------- </

      closeUpdateDialog: function(e) {
        var editDialog = document.querySelector('#' + e.target.title);
        editDialog.toggle();
      },

      openUpdateDialog: function(e) {
        var editDialog = document.querySelector('#' + e.target.title);

        if ( this.confirmCurrentUser(e) ) {
          editDialog.toggle();
        }
      },

      sendToUpdate: function(e) {
        var editDialog = document.querySelector('#' + e.target.title);
        var visToEdit = {
          id: e.model.__data__.visual.$key,
          title: e.model.__data__.visual.info.title,
          type: e.model.__data__.visual.info.type,
          data: e.model.__data__.visual.info.data,
        }
        this.fire('update', visToEdit);
        editDialog.toggle();
      },

      // </ --------------------------------------------------------------------------- </
    });
  </script>
</dom-module>
